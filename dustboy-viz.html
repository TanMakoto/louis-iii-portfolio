<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DustBoy 3D Vision üåå PM2.5 Live</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        :root {
            --bg: #05080a;
            --accent: #39c5bb;
            --danger: #ef4444;
            --safe: #22c55e;
            --warning: #f59e0b;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: var(--bg);
            font-family: 'Inter', sans-serif;
            color: white;
        }

        #canvas-container {
            position: absolute;
            inset: 0;
        }

        .overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            pointer-events: none;
        }

        .hud-panel {
            background: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(57, 197, 187, 0.3);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), inset 0 0 10px rgba(57, 197, 187, 0.1);
        }

        h1 {
            margin: 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            color: var(--accent);
            letter-spacing: 2px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            margin-top: 5px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--accent);
        }

        #data-stream {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 100px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            gap: 10px;
            padding: 10px;
            overflow-x: auto;
            pointer-events: all;
            z-index: 20;
        }

        .data-card {
            min-width: 150px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 8px;
            font-size: 0.75rem;
            border-left: 3px solid var(--accent);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .back-link {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.8rem;
            border: 1px solid var(--accent);
            padding: 5px 15px;
            border-radius: 20px;
            transition: all 0.3s;
            pointer-events: all;
        }

        .back-link:hover {
            background: var(--accent);
            color: var(--bg);
        }

        #active-node {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            width: 250px;
            pointer-events: none;
        }

        .value-display {
            font-size: 2.5rem;
            font-weight: bold;
            font-family: 'Orbitron';
            margin: 10px 0;
        }

        .unit {
            font-size: 0.8rem;
            opacity: 0.6;
        }
    </style>
</head>

<body>

    <a href="index.html" class="back-link">‚Üê Return to Nexus</a>

    <div id="canvas-container"></div>

    <div class="overlay">
        <div class="hud-panel">
            <h1>DUSTBOY VISION v2.0</h1>
            <div id="mqtt-status" class="status-badge">CONNECTING TO PROTOCOL...</div>
            <p style="font-size: 0.7rem; opacity: 0.7; margin-top: 15px;">REAL-TIME PM2.5 SENSOR NETWORK</p>
        </div>
    </div>

    <div id="active-node">
        <div class="hud-panel" id="detail-panel" style="opacity: 0; transition: opacity 0.5s;">
            <p id="station-name" style="margin: 0; font-size: 0.8rem; color: var(--accent);"></p>
            <div class="value-display"><span id="pm-value">--</span> <span class="unit">¬µg/m¬≥</span></div>
            <p id="station-status" style="margin: 0; font-size: 0.7rem;"></p>
        </div>
    </div>

    <div id="data-stream"></div>

    <script>
        // --- 3D SCENE SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        camera.position.z = 15;

        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0x39c5bb, 1, 100);
        pointLight.position.set(10, 10, 10);
        scene.add(pointLight);

        // Starfield
        const starGeo = new THREE.BufferGeometry();
        const starCoords = [];
        for (let i = 0; i < 3000; i++) {
            starCoords.push((Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200, (Math.random() - 0.5) * 200);
        }
        starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starCoords, 3));
        const starMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1 });
        const stars = new THREE.Points(starGeo, starMat);
        scene.add(stars);

        // Central Nexus Sprite (Glow)
        const nexusGeo = new THREE.SphereGeometry(1, 32, 32);
        const nexusMat = new THREE.MeshStandardMaterial({
            color: 0x39c5bb,
            emissive: 0x39c5bb,
            emissiveIntensity: 2,
            wireframe: true
        });
        const nexus = new THREE.Mesh(nexusGeo, nexusMat);
        scene.add(nexus);

        const nodes = new Map();
        const nodeGroup = new THREE.Group();
        scene.add(nodeGroup);

        // --- MQTT INTEGRATION ---
        const MQTT_URL = 'wss://dustboy-wss-bridge.laris.workers.dev/mqtt';
        const client = mqtt.connect(MQTT_URL);
        const statusEl = document.getElementById('mqtt-status');
        const streamEl = document.getElementById('data-stream');

        client.on('connect', () => {
            statusEl.textContent = 'PROTOCOL CONNECTED: SYSTEM LIVE';
            statusEl.style.borderColor = '#22c55e';
            statusEl.style.color = '#22c55e';
            client.subscribe('DUSTBOY/+/+/+/status');
        });

        client.on('message', (topic, message) => {
            try {
                const data = JSON.parse(message.toString());
                updateNode(data);
                addStreamEvent(data);
            } catch (e) {
                console.error("Payload error", e);
            }
        });

        function getColorFromAQI(pm25) {
            if (pm25 <= 25) return 0x22c55e; // Safe
            if (pm25 <= 50) return 0xf59e0b; // Warning
            return 0xef4444; // Danger
        }

        function updateNode(data) {
            const id = data.nickname || data.id;
            const pm25 = parseFloat(data.pm25);

            if (!nodes.has(id)) {
                // Create new 3D Node
                const geo = new THREE.IcosahedronGeometry(0.5, 1);
                const mat = new THREE.MeshStandardMaterial({
                    color: getColorFromAQI(pm25),
                    emissive: getColorFromAQI(pm25),
                    emissiveIntensity: 1,
                    wireframe: true
                });
                const node = new THREE.Mesh(geo, mat);

                // Random position in sphere around nexus
                const angle = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                const r = 5 + Math.random() * 8;
                node.position.set(
                    r * Math.sin(phi) * Math.cos(angle),
                    r * Math.sin(phi) * Math.sin(angle),
                    r * Math.cos(phi)
                );

                nodeGroup.add(node);
                nodes.set(id, { mesh: node, data: data });

                // Line to Nexus
                const lineMat = new THREE.LineBasicMaterial({ color: 0x39c5bb, transparent: true, opacity: 0.2 });
                const lineGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0, 0, 0), node.position]);
                const line = new THREE.Line(lineGeo, lineMat);
                scene.add(line);
            } else {
                const nodeObj = nodes.get(id);
                nodeObj.mesh.material.color.setHex(getColorFromAQI(pm25));
                nodeObj.mesh.material.emissive.setHex(getColorFromAQI(pm25));
                nodeObj.data = data;
            }

            // Show details of last received node
            showNodeDetails(data);
        }

        function showNodeDetails(data) {
            const panel = document.getElementById('detail-panel');
            const name = document.getElementById('station-name');
            const val = document.getElementById('pm-value');
            const status = document.getElementById('station-status');

            panel.style.opacity = '1';
            name.textContent = data.nickname || "DustBoy Node";
            val.textContent = data.pm25;
            val.style.color = '#' + getColorFromAQI(data.pm25).toString(16).padStart(6, '0');
            status.textContent = `LAST UPDATED: ${new Date().toLocaleTimeString()}`;
        }

        function addStreamEvent(data) {
            const card = document.createElement('div');
            card.className = 'data-card';
            card.style.borderLeftColor = '#' + getColorFromAQI(data.pm25).toString(16).padStart(6, '0');
            card.innerHTML = `
                <div><strong>${data.nickname || 'Unknown'}</strong></div>
                <div>PM2.5: ${data.pm25} ¬µg/m¬≥</div>
            `;
            streamEl.prepend(card);
            if (streamEl.children.length > 20) streamEl.lastChild.remove();
        }

        // --- ANIMATION LOOP ---
        function animate() {
            requestAnimationFrame(animate);

            nexus.rotation.y += 0.01;
            stars.rotation.y += 0.0005;
            nodeGroup.rotation.y += 0.002;

            nodes.forEach(node => {
                node.mesh.rotation.x += 0.02;
                node.mesh.rotation.y += 0.02;
                // Subtle pulse
                const s = 1 + Math.sin(Date.now() * 0.005) * 0.1;
                node.mesh.scale.set(s, s, s);
            });

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();
    </script>
</body>

</html>